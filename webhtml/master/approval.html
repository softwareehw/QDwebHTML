<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>审批</title>
<link href="../../css/bootstrap.min.css" rel="stylesheet">
<link href="../../font-awesome/css/font-awesome.css" rel="stylesheet">
<link href="../../css/animate.css" rel="stylesheet">
<link href="../../css/style.css" rel="stylesheet">
<link href="../../css/plugins/iCheck/custom.css" rel="stylesheet">
<!-- Mainly scripts -->
<script src="../../js/jquery-3.1.1.min.js"></script>
<script src="../../js/popper.min.js"></script>
<script src="../../js/bootstrap.js"></script>
<script src="../../js/plugins/metisMenu/jquery.metisMenu.js"></script>
<script src="../../js/plugins/slimscroll/jquery.slimscroll.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vue"></script>
<script src="../../js/plugins/iCheck/icheck.min.js"></script>

<!-- Custom and plugin javascript -->
<script src="../../js/inspinia.js"></script>
<script src="../../js/plugins/pace/pace.min.js"></script>
 <script src="https://unpkg.com/vue/dist/vue.js"></script>
<!-- jQuery UI -->
<script src="../../js/plugins/jquery-ui/jquery-ui.min.js"></script>

<!-- EayPIE -->
<script src="../../js/plugins/easypiechart/jquery.easypiechart.js"></script>

<!-- Sparkline -->
<script src="../../js/plugins/sparkline/jquery.sparkline.min.js"></script>

<!-- Sparkline demo data  -->
<script src="../../js/demo/sparkline-demo.js"></script>
</head>

<body>
<div id="wrapper" class="gray-bg">
  <div id="page-wrapper" class="gray-bg" style="margin: 0;">
    <div class="wrapper wrapper-content"  id="app2">
      <div class="row"> 
          <div class="col-lg-12">
          <div class="mail-box-header">
            <h2> 部门员工请假申请 </h2>
            <div class="mail-tools tooltip-demo m-t-md">
              <button class="btn btn-white btn-sm" data-toggle="tooltip" data-placement="left" title="Refresh inbox"><i class="fa fa-refresh"></i> 刷新 </button>
              <button class="btn btn-white btn-sm" data-toggle="tooltip" data-placement="top" title="agree"  v-on:click="approvalApp"><i class="fa fa-exclamation"></i> 同意 </button>
              <button class="btn btn-white btn-sm" data-toggle="tooltip" data-placement="top" title="disagree"  v-on:click="disApprovalApp"><i class="fa fa-trash-o" ></i> 驳回 </button>
            </div>
          </div>
          <div class="mail-box">
            <table class="table table-hover table-mail">
              <tbody>
                <tr class="title">
                  <td class="check-mail"></td>
                  <td class="mail-ontact">员工姓名</td>
                  <td class="mail-ontact">员工编号</td>
                  <td class="mail-ontact">开始时间</td>
                  <td class="mail-ontact">结束时间</td>
                </tr> 
				  
				  
                <tr class="read" v-for="(leaveApp,index) in leaveApps">
                  <td class="check-mail"><input type="checkbox" class="i-checks" :id='"drop-remove_"+index'></td>
                  <td class="mail-ontact">{{leaveApp.applicatdPersonName}}</td>
                  <td class="mail-ontact">{{leaveApp.applicatdPerson}}</td>
                  <td class="mail-ontact">{{leaveApp.startTime}}</td>
                  <td class="mail-ontact">{{leaveApp.endTime}}</td>
                </tr>
              </tbody>
            </table>
			  <div v-if="leaveApps.length==0" align="center" style="margin: 20px 0px">
				  	没有任何记录
				  </div>
          </div>
        </div>
		  <div class="col-lg-12">
          <div class="mail-box-header">
            <h2> 部门员工加班申请 </h2>
            <div class="mail-tools tooltip-demo m-t-md">
              <button class="btn btn-white btn-sm" data-toggle="tooltip" data-placement="left" title="Refresh inbox"><i class="fa fa-refresh"></i> 刷新 </button>
              <button class="btn btn-white btn-sm" data-toggle="tooltip" data-placement="top" title="agree"  v-on:click="approvalEXApp"><i class="fa fa-exclamation"></i> 同意 </button>
              <button class="btn btn-white btn-sm" data-toggle="tooltip" data-placement="top" title="disagree"  v-on:click="disApprovalEXApp"><i class="fa fa-trash-o" ></i> 驳回 </button>
            </div>
          </div>
          <div class="mail-box">
            <table class="table table-hover table-mail">
              <tbody>
                <tr class="title">
                  <td class="check-mail"></td>
                  <td class="mail-ontact">员工姓名</td>
                  <td class="mail-ontact">员工编号</td>
                  <td class="mail-ontact">开始时间</td>
                  <td class="mail-ontact">结束时间</td>
                </tr> 

                <tr class="read" v-for="(EXwork,index) in EXworks"  v-if="EXwork.ewState==0">
                  <td class="check-mail"><input type="checkbox" class="i-checks" :id='"drop-remove2_"+index'></td>
                  <td class="mail-ontact"><a href="../manager/mail_detail.html">duff</a></td>
                  <td class="mail-ontact"><a href="../manager/mail_detail.html">{{EXwork.applicatedId}}</a></td>
                  <td class="mail-ontact"><a href="../manager/mail_detail.html">{{EXwork.startTime}}</a></td>
                  <td class="mail-ontact"><a href="../manager/mail_detail.html">{{EXwork.endTime}}</a></td>
                </tr> 
              </tbody>
            </table>
			  		<div v-if="EXworks.length==0" align="center" style="margin: 20px 0px"> 
				  	没有任何记录
				  </div>
          </div>
        </div>

            <div class="col-lg-12">
              <div class="ibox ">
                <div class="ibox-title">
                  <h5>加班申请历史记录 <small> 在此处查看加班申请记录，包括待批、同意、驳回…… </small></h5>
                  <div class="ibox-tools"> <a class="collapse-link"> <i class="fa fa-chevron-up"></i> </a> <a class="dropdown-toggle" data-toggle="dropdown" href="#"> <i class="fa fa-wrench"></i> </a>
                    <ul class="dropdown-menu dropdown-user">
                      <li><a href="#" class="dropdown-item">Config option 1</a> </li>
                      <li><a href="#" class="dropdown-item">Config option 2</a> </li>
                    </ul>
                    <a class="close-link"> <i class="fa fa-times"></i> </a> </div>
                </div>
                <div class="ibox-content">
                  <div class="table-responsive">
                    <table class="table table-striped table-bordered table-hover dataTables-example" >
                      <thead>
                        <tr>
                          <th>编号</th>
                          <th>申请人名字</th>
                          <th>申请人工号)</th>
                          <th>开始时间</th>
                          <th>结束时间</th>
							<th>审批人工号</th>
							<th>申请状态</th>

                        </tr>
                      </thead>
                      <tbody>
						   
                        <tr class="gradeX" v-for="(EXworkHistory,index) in EXworksHistory">
                          <td>{{index}}</td>
                          <td>{{EXworkHistory.name}}</td>
                          <td>{{EXworkHistory.applicatedId}}</td>
                          <td class="center">{{EXworkHistory.startTime}}</td>
                          <td class="center">{{EXworkHistory.endTime}}</td>
							<td class="center">{{EXworkHistory.ratifyId}}</td>
							<td class="center"  v-if="EXworkHistory.ewState==1">同意</td>
							<td class="center"  v-if="EXworkHistory.ewState==0">待批</td>
							<td class="center"  v-if="EXworkHistory.ewState==2">驳回</td>
                        </tr>
                      </tbody>
                    
                    </table>
					  <div v-if="EXworksHistory.length==0" align="center" style="margin: 20px 0px">
				  	没有任何记录
				  </div>
                  </div>
                </div>
              </div>
            </div>

      </div>
    </div>
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){
            $('.i-checks').iCheck({
                checkboxClass: 'icheckbox_square-green',
                radioClass: 'iradio_square-green'
            });
})
  new Vue({
    el:"#app2",
    data:{
	  userInfo:[],
      selected:[],
	  leaveApps:[],
	  ajaxFlag:0,
	  person:[],
	  staffs:[],
	  EXworks:[],
	  EXworksArr:[],
	  EXworksHistory:[]
    },
    methods:{
		///page init
		pageInit:function(){
			 $('.i-checks').iCheck({
                checkboxClass: 'icheckbox_square-green',
                radioClass: 'iradio_square-green'
            });
		},
		///根据employeeId获取员工名
		getEmployeeById:function(employeeId){
			console.log("getEmployeeById begin ")
			var that = this
				jQuery.ajax({
					   type:"GET",
					   url:"http://39.105.38.34:8080/api/v1/employees/"+employeeId,
					   contentType:"application/json",
					   xhrFields: {
						 withCredentials: true
					   },
					async:false,
					   crossDomain: true,
					   success:function(data){
						 that.person = JSON.parse(data)[0];
					   },
					   error:function(data){
						 console.log("fail");
					   }
         			});
		},
		///获取某部门所有待批准的请假申请
		getLeaveAppByDepId:function(departmentId){
			var that=this;
			jQuery.ajax({
					   type:"GET",
					   url:"http://39.105.38.34:8080/api/v1/leaves/uncheck/sectors/"+departmentId,
					   contentType:"application/json",
					   xhrFields: {
						 withCredentials: true
					   },
					   crossDomain: true,
						async:false,
					   success:function(data){
						   if(JSON.parse(data).state!=0)
						 {that.leaveApps = JSON.parse(data);}
						  console.dir("that.leaveApps")
						    console.dir(that.leaveApps)
					   },
					   error:function(data){
						 console.log("fail");
					   }
         			});
		},
		///管理员批准某请假申请 (可用)
		approvalApp:function(){
			var that=this;
			for(var i=0;i<this.leaveApps.length;i++){
				if ($('#drop-remove_'+i).is(':checked')){
					//console.log(i+" is cheaked")
					var jsono={};
					jsono["leaveId"]=this.leaveApps[i].leaveId;
					jsono["ratifiedPerson"]=that.userInfo.employeeId;
					jsono["state"]="1";
					jQuery.ajax({
					   type:"POST",
					   url:"http://39.105.38.34:8080/api/v1/leaves/ratify",
					   contentType:"application/json",
					   xhrFields: {
						 withCredentials: true
					   },
						dataType:"json",
						data:JSON.stringify(jsono),
					   crossDomain: true,
						async:false,
					   success:function(data){
						   alert("操作成功")
						window.location.reload()
					   },
					   error:function(data){
						   alert("操作失败")
						 console.log("fail");
					   }
         			});
				}
			}
			
			
		},
		///管理员拒绝某请假申请 （不可用）
		disApprovalApp:function(){
			var that=this;
			for(var i=0;i<this.leaveApps.length;i++){
				if ($('#drop-remove_'+i).is(':checked')){
					//console.log(i+" is cheaked")
					var jsono={};
					jsono["leaveId"]=this.leaveApps[i].leaveId;
					jsono["ratifiedPerson"]=that.userInfo.employeeId;
					jsono["state"]="0";
					jQuery.ajax({
					   type:"POST",
					   url:"http://39.105.38.34:8080/api/v1/leaves/ratify",
					   contentType:"application/json",
					   xhrFields: {
						 withCredentials: true
					   },
						dataType:"json",
						data:JSON.stringify(jsono),
					   crossDomain: true,
						async:false,
					   success:function(data){
						window.location.reload()
					   },
					   error:function(data){
						 console.log("fail");
					   }
         			});
				}
			}
			
			
		},
		
		///通过员工ID查询加班申请
		getExworkByStaffId:function(StaffId){
			var that=this;
			jQuery.ajax({
					   type:"GET",
					   url:"http://39.105.38.34:8080/api/v1/EWs/employees/"+StaffId,
					   contentType:"application/json",
					   xhrFields: {
						 withCredentials: true
					   },
					   crossDomain: true,
						async:false,
					   success:function(data){
						   
						 that.EXworksArr.push( JSON.parse(data));
						  for(var i = 0; i< that.EXworksArr[0].length;i++){
							  that.EXworksHistory.push(that.EXworksArr[0][i]);
						  }

					   },

					   error:function(data){
						 console.log("fail");
					   }
         			});
			
		},
		///通过部门ID查询待审批加班申请
		getExworkByDepartId:function(sectorId){
			var that=this;
			jQuery.ajax({
					   type:"GET",
					   url:"http://39.105.38.34:8080/api/v1/EWs/uncheck/sectors/"+sectorId,
					   contentType:"application/json",
					   xhrFields: {
						 withCredentials: true
					   },
					   crossDomain: true,
						async:false,
					   success:function(data){
						 that.EXworks=JSON.parse(data);
					   },

					   error:function(data){
						 console.log("fail");
					   }
         			});
			
		},
		///查某部门所有员工(可用)
        getAllStaffByDepartId:function(DepartId){
			var that = this;
      		jQuery.ajax({
			type:"GET",
			url:"http://39.105.38.34:8080/api/v1/employees/sectors/"+DepartId,
			contentType:"application/json",
			xhrFields: {
			  withCredentials: true
			},
			async:false,
			crossDomain: true,
			success:function(data){
			  that.staffs=JSON.parse(data);
			},
			error:function(data){
			  console.log("fail");

			}
		  })
		},

		///批准加班申请
		approvalEXApp:function(EXId){
			var that=this;
			var jsono={};
			for(var i=0;i<this.EXworks.length;i++){
				if ($('#drop-remove2_'+i).is(':checked')){
					jsono["ewId"]=this.EXworks[i].ewId;
					jsono["ratifyId"]=1;
					jsono["ewState"]=1;
					jQuery.ajax({
					type:"POST",
					url:"http://39.105.38.34:8080/api/v1/EWs/ratify",
					contentType:"application/json",
					xhrFields: {
					  withCredentials: true
					},
					dataType:"json",
					data:JSON.stringify(jsono),
					async:false,
					crossDomain: true,
					success:function(data){
					  alert("操作成功")
					  window.location.reload()
					},
					error:function(data){
						alert("操作失败")
						 console.log("fail");
					}
				  })
				}
			}
		},
		///不批准某条加班申请
		disApprovalEXApp:function(EXId){
			var that=this;
			var jsono={};
			for(var i=0;i<this.EXworks.length;i++){
				if ($('#drop-remove2_'+i).is(':checked')){
					jsono["ewId"]=this.EXworks[i].ewId;
					jsono["ratifyId"]=1;
					jsono["ewState"]=2;
					jQuery.ajax({
					type:"POST",
					url:"http://39.105.38.34:8080/api/v1/EWs/ratify",
					contentType:"application/json",
					xhrFields: {
					  withCredentials: true
					},
					dataType:"json",
					data:JSON.stringify(jsono),
					async:false,
					crossDomain: true,
					success:function(data){
					  alert("操作成功")
					  window.location.reload()
					},
					error:function(data){
						alert("操作失败")
						 console.log("fail");
					}
				  })
				}
			}
		
		}
	},
    created:function(){
		this.userInfo = JSON.parse(sessionStorage.userInfo)//获取管理员信息
		this.getLeaveAppByDepId(this.userInfo.sectorId);///获取待批准ID
		for(var i=0;i<this.leaveApps.length;i++){        ////获取名字
				this.getEmployeeById(this.leaveApps[i].applicatdPerson)
				this.leaveApps[i]["applicatdPersonName"] = this.person.name}
		
		////以上代码没问题
		this.getAllStaffByDepartId(this.userInfo.sectorId);
		this.getExworkByDepartId(this.userInfo.sectorId)
		
		
		//////加班申请历史记录
		for(var i =0 ;i<this.staffs.length;i++){
			if(this.staffs[i].employeeId != this.userInfo.employeeId){
			this.getExworkByStaffId(this.staffs[i].employeeId)}
		}
		///把名字添加到加班申请历史记录数组中
		for(var i=0;i<this.EXworksHistory.length;i++){        ////获取名字
				this.getEmployeeById(this.EXworksHistory[i].applicatedId)
				this.EXworksHistory[i]["name"] = this.person.name
		}
						   console.dir(" that.EXworks.push")
						   console.dir(this.EXworksHistory)
		
    }

  })

</script>
</body>
</html>
