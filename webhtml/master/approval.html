<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>审批</title>
<link href="../../css/bootstrap.min.css" rel="stylesheet">
<link href="../../font-awesome/css/font-awesome.css" rel="stylesheet">
<link href="../../css/animate.css" rel="stylesheet">
<link href="../../css/style.css" rel="stylesheet">
<link href="../../css/plugins/iCheck/custom.css" rel="stylesheet">
<!-- Mainly scripts -->
<script src="../../js/jquery-3.1.1.min.js"></script>
<script src="../../js/popper.min.js"></script>
<script src="../../js/bootstrap.js"></script>
<script src="../../js/plugins/metisMenu/jquery.metisMenu.js"></script>
<script src="../../js/plugins/slimscroll/jquery.slimscroll.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vue"></script>
<script src="../../js/plugins/iCheck/icheck.min.js"></script>

<!-- Custom and plugin javascript -->
<script src="../../js/inspinia.js"></script>
<script src="../../js/plugins/pace/pace.min.js"></script>
 <script src="https://unpkg.com/vue/dist/vue.js"></script>
<!-- jQuery UI -->
<script src="../../js/plugins/jquery-ui/jquery-ui.min.js"></script>

<!-- EayPIE -->
<script src="../../js/plugins/easypiechart/jquery.easypiechart.js"></script>

<!-- Sparkline -->
<script src="../../js/plugins/sparkline/jquery.sparkline.min.js"></script>

<!-- Sparkline demo data  -->
<script src="../../js/demo/sparkline-demo.js"></script>
</head>

<body>
<div id="wrapper" class="gray-bg">
  <div id="page-wrapper" class="gray-bg" style="margin: 0;">
    <div class="wrapper wrapper-content"  id="app2">
      <div class="row"> 
    
        <div class="col-lg-12">
          <div class="mail-box-header">
            <h2> 部门员工请假申请 </h2>
            <div class="mail-tools tooltip-demo m-t-md">
              <button class="btn btn-white btn-sm" data-toggle="tooltip" data-placement="left" title="Refresh inbox"><i class="fa fa-refresh"></i> 刷新 </button>
              <button class="btn btn-white btn-sm" data-toggle="tooltip" data-placement="top" title="agree"  v-on:click="approvalApp"><i class="fa fa-exclamation"></i> 同意 </button>
              <button class="btn btn-white btn-sm" data-toggle="tooltip" data-placement="top" title="disagree"  v-on:click="approvalApp"><i class="fa fa-trash-o" ></i> 驳回 </button>
            </div>
          </div>
          <div class="mail-box">
            <table class="table table-hover table-mail">
              <tbody>
                <tr class="title">
                  <td class="check-mail"></td>
                  <td class="mail-ontact">员工姓名</td>
                  <td class="mail-ontact">员工编号</td>
                  <td class="mail-ontact">开始时间</td>
                  <td class="mail-ontact">结束时间</td>
                </tr> 
                <tr class="read" v-for="(leaveApp,index) in leaveApps">
                  <td class="check-mail"><input type="checkbox" class="i-checks" :id='"drop-remove_"+index'></td>
                  <td class="mail-ontact"><a href="../manager/mail_detail.html">{{leaveApp.applicatdPersonName}}</a></td>
                  <td class="mail-ontact"><a href="../manager/mail_detail.html">{{leaveApp.applicatdPerson}}</a></td>
                  <td class="mail-ontact"><a href="../manager/mail_detail.html">{{leaveApp.startTime}}</a></td>
                  <td class="mail-ontact"><a href="../manager/mail_detail.html">{{leaveApp.endTime}}</a></td>
                </tr>
				  
				  
              </tbody>
            </table>
          </div>
        </div>
       
		  
		  
		  <div class="col-lg-12">
          <div class="mail-box-header">
            <h2> 部门员工加班申请 </h2>
            <div class="mail-tools tooltip-demo m-t-md">
              <button class="btn btn-white btn-sm" data-toggle="tooltip" data-placement="left" title="Refresh inbox"><i class="fa fa-refresh"></i> 刷新 </button>
              <button class="btn btn-white btn-sm" data-toggle="tooltip" data-placement="top" title="agree"  v-on:click="approvalEXApp"><i class="fa fa-exclamation"></i> 同意 </button>
              <button class="btn btn-white btn-sm" data-toggle="tooltip" data-placement="top" title="disagree"  v-on:click="approvalEXApp"><i class="fa fa-trash-o" ></i> 驳回 </button>
            </div>
          </div>
          <div class="mail-box">
            <table class="table table-hover table-mail">
              <tbody>
                <tr class="title">
                  <td class="check-mail"></td>
                  <td class="mail-ontact">员工姓名</td>
                  <td class="mail-ontact">员工编号</td>
                  <td class="mail-ontact">开始时间</td>
                  <td class="mail-ontact">结束时间</td>
                </tr> 
                <tr class="read" v-for="(EXwork2,index) in EXworks2">
                  <td class="check-mail"><input type="checkbox" class="i-checks" :id='"drop-remove_"+index'></td>
                  <td class="mail-ontact"><a href="../manager/mail_detail.html">duff</a></td>
                  <td class="mail-ontact"><a href="../manager/mail_detail.html">{{EXwork2.applicatedId}}</a></td>
                  <td class="mail-ontact"><a href="../manager/mail_detail.html">{{EXwork2.startTime}}</a></td>
                  <td class="mail-ontact"><a href="../manager/mail_detail.html">{{EXwork2.endTime}}</a></td>
                </tr>
				  
				  
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){
            $('.i-checks').iCheck({
                checkboxClass: 'icheckbox_square-green',
                radioClass: 'iradio_square-green'
            });
})
  new Vue({
    el:"#app2",
    data:{
		userInfo:[],
      selected:[],
	  leaveApps:[],
	  ajaxFlag:0,
	  person:[],
	  staffs:[],
	  EXworks:[],
	  EXworks2:[]
    },
    methods:{
		///page init
		pageInit:function(){
			 $('.i-checks').iCheck({
                checkboxClass: 'icheckbox_square-green',
                radioClass: 'iradio_square-green'
            });
		},
		///根据employeeId获取员工名
		getEmployeeById:function(employeeId){
			console.log("getEmployeeById begin ")
			var that = this
				jQuery.ajax({
					   type:"GET",
					   url:"http://39.105.38.34:8080/api/v1/employees/"+employeeId,
					   contentType:"application/json",
					   xhrFields: {
						 withCredentials: true
					   },
					async:false,
					   crossDomain: true,
					   success:function(data){
						 that.person = JSON.parse(data)[0];
					   },
					   error:function(data){
						 console.log("fail");
					   }
         			});
		},
		///获取某部门所有待批准的请假申请(接口地址待修改)
		getLeaveAppByDepId:function(departmentId){
			var that=this;
			jQuery.ajax({
					   type:"GET",
					   url:"http://39.105.38.34:8080/api/v1/leaves/uncheck/sectors/"+departmentId,
					   contentType:"application/json",
					   xhrFields: {
						 withCredentials: true
					   },
					   crossDomain: true,
						async:false,
					   success:function(data){
						 that.leaveApps = JSON.parse(data);
					   },
					   error:function(data){
						 console.log("fail");
					   }
         			});
		},
		///管理员批准某请假申请 (可用)
		approvalApp:function(){
			var that=this;
			for(var i=0;i<this.leaveApps.length;i++){
				if ($('#drop-remove_'+i).is(':checked')){
					//console.log(i+" is cheaked")
					var jsono={};
					jsono["leaveId"]=this.leaveApps[i].leaveId;
					jsono["ratifiedPerson"]=localStorage.getItem("employeeId");
					jsono["state"]="1";
					jQuery.ajax({
					   type:"POST",
					   url:"http://39.105.38.34:8080/api/v1/leaves/ratify",
					   contentType:"application/json",
					   xhrFields: {
						 withCredentials: true
					   },
						dataType:"json",
						data:JSON.stringify(jsono),
					   crossDomain: true,
						async:false,
					   success:function(data){
						window.location.reload()
					   },
					   error:function(data){
						 console.log("fail");
					   }
         			});
				}
			}
			
			
		},
		///管理员拒绝某请假申请 （不可用）
		disApprovalApp:function(){
			var that=this;
			for(var i=0;i<this.leaveApps.length;i++){
				if ($('#drop-remove_'+i).is(':checked')){
					//console.log(i+" is cheaked")
					var jsono={};
					jsono["leaveId"]=this.leaveApps[i].leaveId;
					jsono["ratifiedPerson"]=localStorage.getItem("employeeId");
					jsono["state"]="0";
					jQuery.ajax({
					   type:"POST",
					   url:"http://39.105.38.34:8080/api/v1/leaves/ratify",
					   contentType:"application/json",
					   xhrFields: {
						 withCredentials: true
					   },
						dataType:"json",
						data:JSON.stringify(jsono),
					   crossDomain: true,
						async:false,
					   success:function(data){
						window.location.reload()
					   },
					   error:function(data){
						 console.log("fail");
					   }
         			});
				}
			}
			
			
		},
		
		///查询加班申请
		getExworkByStaffId:function(StaffId){
			var that=this;
			jQuery.ajax({
					   type:"GET",
					   url:"http://39.105.38.34:8080/api/v1/EWs/employees/"+StaffId,
					   contentType:"application/json",
					   xhrFields: {
						 withCredentials: true
					   },
					   crossDomain: true,
						async:false,
					   success:function(data){
						 that.EXworks.push( JSON.parse(data));
					   },

					   error:function(data){
						 console.log("fail");
					   }
         			});
			
		},
		///查某部门所有员工(可用)
        getAllStaffByDepartId:function(DepartId){
			var that = this;
      		jQuery.ajax({
			type:"GET",
			url:"http://39.105.38.34:8080/api/v1/employees/sectors/"+DepartId,
			contentType:"application/json",
			xhrFields: {
			  withCredentials: true
			},
			async:false,
			crossDomain: true,
			success:function(data){
			  that.staffs=JSON.parse(data);
			},
			error:function(data){
			  console.log("fail");

			}
		  })
		},

		///批准加班申请
		approvalEXApp:function(EXId){
			var that=this;
			var jsono={};
			jsono["ewId"]=EXId;
			jsono["ratifyId"]=1;
			jsono["ewState"]=1;
			jQuery.ajax({
			type:"POST",
			url:"http://39.105.38.34:8080/api/v1/EWs/ratify",
			contentType:"application/json",
			xhrFields: {
			  withCredentials: true
			},
			dataType:"json",
			data:JSON.stringify(jsono),
			async:false,
			crossDomain: true,
			success:function(data){
			  console.log("succ")
			},
			error:function(data){
			  console.log("fail");

			}
		  })
		},
		///不批准某条加班申请
		disApprovalEXApp:function(EXId){
			var that=this;
			var jsono={};
			jsono["ewId"]=EXId;
			jsono["ratifyId"]=1;
			jsono["ewState"]=2;
			jQuery.ajax({
			type:"POST",
			url:"http://39.105.38.34:8080/api/v1/EWs/ratify",
			contentType:"application/json",
			xhrFields: {
			  withCredentials: true
			},
			dataType:"json",
			data:JSON.stringify(jsono),
			async:false,
			crossDomain: true,
			success:function(data){
			  console.log("succ")
			},
			error:function(data){
			  console.log("fail");

			}
		  })
		}
    },
    created:function(){
		this.userInfo = JSON.parse(sessionStorage.userInfo)//获取管理员信息
		this.getLeaveAppByDepId(this.userInfo.sectorId);///获取待批准ID
		for(var i=0;i<this.leaveApps.length;i++){        ////获取名字
				this.getEmployeeById(this.leaveApps[i].applicatdPerson)
				this.leaveApps[i]["applicatdPersonName"] = this.person.name}
		////以上代码没问题
		this.getAllStaffByDepartId(this.userInfo.sectorId);
			for(var i=0;i<this.staffs.length;i++){
				this.getExworkByStaffId(this.staffs[i].employeeId)
			}
//		this.getExworkByStaffId(12)
//		console.log("fin")
//		this.EXworks2=this.EXworks[0]
//      console.dir(this.EXworks2)
		
    }

  })

</script>
</body>
</html>
